name: Azure Infrastructure Inovy

permissions:
  id-token: write
  contents: read
  actions: read

env:
  ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
  ARM_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
  ARM_USE_OIDC: true

defaults:
  run:
    shell: bash

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        type: string
        default: "prd"
      resource_group_name:
        description: "Resource group name for Terraform state storage"
        required: true
        type: string
        default: "rg-terraform-states"
      location:
        description: "Azure region for resources"
        required: true
        type: string
        default: "westeurope"
      terraform_unlock:
        description: "Optional: Lock ID to force-unlock Terraform state (use when state is locked)"
        required: false
        type: string

jobs:
  terraform-plan:
    if: ${{ inputs.environment == 'prd' }}
    environment: prd
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: Terraform Init and Validate
        working-directory: infrastructure
        run: |
          terraform init
          terraform validate

      - name: Create terraform.tfvars from TF_VARS
        working-directory: infrastructure
        run: |
          # Decode base64-encoded TF_VARS and write to terraform.tfvars file
          echo "${{ vars.TF_VARS }}" | base64 -d > terraform.tfvars
          echo "Created terraform.tfvars from decoded TF_VARS environment variable"

      - name: Terraform Force Unlock
        if: ${{ inputs.terraform_unlock != '' }}
        working-directory: infrastructure
        run: |
          echo "Force unlocking Terraform state with lock ID: ${{ inputs.terraform_unlock }}"
          terraform force-unlock -force "${{ inputs.terraform_unlock }}"

      - name: Terraform Plan
        working-directory: infrastructure
        env:
          TF_VAR_postgresql_admin_login: ${{ secrets.POSTGRESQL_ADMIN_LOGIN }}
          TF_VAR_postgresql_admin_password: ${{ secrets.POSTGRESQL_ADMIN_PASSWORD }}
        run: |
          terraform plan \
            -input=false \
            -out=tfplan \
            -var="environment=${{ inputs.environment }}" \
            -var="location=${{ inputs.location }}" \
            -var="entra_tenant_id=${{ vars.AZURE_TENANT_ID }}" \
            -var-file=terraform.tfvars

      - name: Upload Plan to Storage Account
        run: |
          STORAGE_ACCOUNT_NAME="sttf${{ inputs.environment }}inovy"
          PLAN_FILE="infrastructure/tfplan"
          PLAN_BLOB_NAME="${{ inputs.environment }}/tfplan"

          if [ -f "$PLAN_FILE" ]; then
            echo "Uploading plan file to storage account..."
            az storage blob upload \
              --account-name "$STORAGE_ACCOUNT_NAME" \
              --container-name tfstate \
              --name "$PLAN_BLOB_NAME" \
              --file "$PLAN_FILE" \
              --auth-mode login \
              --overwrite
            echo "Plan file uploaded successfully: $PLAN_BLOB_NAME"
          else
            echo "ERROR: Plan file not found at $PLAN_FILE"
            exit 1
          fi

  terraform-apply:
    environment: ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: terraform-plan

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: Terraform Init
        working-directory: infrastructure
        run: terraform init

      - name: Download Plan from Storage Account
        run: |
          STORAGE_ACCOUNT_NAME="sttf${{ inputs.environment }}inovy"
          PLAN_FILE="infrastructure/tfplan"
          PLAN_BLOB_NAME="${{ inputs.environment }}/tfplan"

          echo "Downloading plan file from storage account..."
          if az storage blob download \
            --account-name "$STORAGE_ACCOUNT_NAME" \
            --container-name tfstate \
            --name "$PLAN_BLOB_NAME" \
            --file "$PLAN_FILE" \
            --auth-mode login 2>/dev/null; then
            echo "Plan file downloaded successfully"
          else
            echo "ERROR: Plan file not found in storage account. Plan job must complete successfully first."
            exit 1
          fi

      - name: Terraform Apply
        working-directory: infrastructure
        run: |
          if [ -f "tfplan" ]; then
            echo "Applying plan from saved tfplan file..."
            terraform apply -auto-approve tfplan 
          else
            echo "ERROR: Plan file not found. Cannot apply without a plan."
            exit 1
          fi
        env:
          TF_VAR_postgresql_admin_login: ${{ secrets.POSTGRESQL_ADMIN_LOGIN }}
          TF_VAR_postgresql_admin_password: ${{ secrets.POSTGRESQL_ADMIN_PASSWORD }}
