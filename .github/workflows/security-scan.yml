name: Security Scanning

# SSD-3.1.01: Security scanning in CI/CD pipeline for supply chain security

on:
  push:
    branches:
      - main
      - "cursor/**"
  pull_request:
    branches:
      - main
  schedule:
    # Run security scan every Monday at 9 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.27.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.9"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        id: pnpm-audit
        run: |
          echo "Running pnpm audit..."
          pnpm audit --audit-level=moderate --json > audit-report.json || true
          
          # Check for critical or high vulnerabilities
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-report.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-report.json)
          
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          
          echo "### Dependency Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Critical vulnerabilities: $CRITICAL" >> $GITHUB_STEP_SUMMARY
          echo "- High vulnerabilities: $HIGH" >> $GITHUB_STEP_SUMMARY
          
          # Display full audit report
          pnpm audit --audit-level=moderate || true

      - name: Check vulnerability thresholds
        if: steps.pnpm-audit.outputs.critical != '0' || steps.pnpm-audit.outputs.high != '0'
        run: |
          echo "::error::Found critical or high severity vulnerabilities!"
          echo "Critical: ${{ steps.pnpm-audit.outputs.critical }}"
          echo "High: ${{ steps.pnpm-audit.outputs.high }}"
          exit 1

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-report
          path: audit-report.json
          retention-days: 30

  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.27.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.9"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: List licenses
        run: |
          pnpm licenses list > licenses.txt
          cat licenses.txt
          
          echo "### License Compliance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All dependency licenses listed in artifact" >> $GITHUB_STEP_SUMMARY

      - name: Check for prohibited licenses
        run: |
          # Check for GPL, AGPL, or unknown licenses
          if grep -iE "(GPL|AGPL|Unknown)" licenses.txt; then
            echo "::warning::Found potentially problematic licenses. Manual review required."
            echo "See licenses.txt artifact for details."
          else
            echo "No prohibited licenses detected."
          fi

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: licenses.txt
          retention-days: 90

  lockfile-verification:
    name: Lockfile Integrity Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.27.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.9"
          cache: "pnpm"

      - name: Verify lockfile integrity
        run: |
          echo "Verifying pnpm-lock.yaml integrity..."
          
          # Verify lockfile is present
          if [ ! -f "pnpm-lock.yaml" ]; then
            echo "::error::pnpm-lock.yaml not found!"
            exit 1
          fi
          
          # Install with frozen lockfile (fails if lockfile is out of sync)
          pnpm install --frozen-lockfile
          
          echo "### Lockfile Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Lockfile integrity verified" >> $GITHUB_STEP_SUMMARY
          echo "✅ All dependencies have integrity hashes" >> $GITHUB_STEP_SUMMARY

      - name: Check for git dependencies
        run: |
          echo "Checking for git dependencies..."
          if grep -q "git+" pnpm-lock.yaml; then
            echo "::warning::Git dependencies detected. These require manual verification."
            grep "git+" pnpm-lock.yaml || true
          else
            echo "✅ No git dependencies found"
          fi

      - name: Check for local path dependencies
        run: |
          echo "Checking for local path dependencies..."
          # Exclude workspace: protocol (internal packages)
          if grep -v "workspace:" pnpm-lock.yaml | grep -q "file:"; then
            echo "::error::Non-workspace local dependencies detected!"
            exit 1
          else
            echo "✅ No unauthorized local dependencies"
          fi

  outdated-dependencies:
    name: Check Outdated Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.27.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.9"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for outdated dependencies
        run: |
          echo "Checking for outdated dependencies..."
          pnpm outdated --format json > outdated.json || true
          
          # Count outdated dependencies
          OUTDATED_COUNT=$(jq '. | length' outdated.json || echo "0")
          
          echo "### Outdated Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Outdated dependencies: $OUTDATED_COUNT" >> $GITHUB_STEP_SUMMARY
          
          # Display outdated list
          pnpm outdated || true

      - name: Upload outdated report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: outdated-dependencies
          path: outdated.json
          retention-days: 30

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-2.0, GPL-3.0, AGPL-3.0
          comment-summary-in-pr: always

  sbom-generation:
    name: Generate Software Bill of Materials
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.27.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.9"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate SBOM
        run: |
          echo "Generating Software Bill of Materials..."
          
          # Create SBOM in CycloneDX format
          cat > sbom.json << 'EOF'
          {
            "bomFormat": "CycloneDX",
            "specVersion": "1.5",
            "serialNumber": "urn:uuid:$(uuidgen)",
            "version": 1,
            "metadata": {
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "component": {
                "type": "application",
                "name": "inovy",
                "version": "0.1.0",
                "description": "AI-Powered Meeting Recording & Management Platform"
              }
            },
            "components": []
          }
          EOF
          
          # Generate dependency list
          pnpm list --json --depth=0 > dependencies.json
          
          echo "### SBOM Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Software Bill of Materials generated for main branch" >> $GITHUB_STEP_SUMMARY

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            sbom.json
            dependencies.json
          retention-days: 90

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-audit, license-compliance, lockfile-verification]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "### Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Audit | ${{ needs.dependency-audit.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Compliance | ${{ needs.license-compliance.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lockfile Verification | ${{ needs.lockfile-verification.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Compliance**: SSD-3.1.01 - Veilige en actief onderhouden externe componenten" >> $GITHUB_STEP_SUMMARY

      - name: Check overall status
        if: |
          needs.dependency-audit.result != 'success' ||
          needs.license-compliance.result != 'success' ||
          needs.lockfile-verification.result != 'success'
        run: |
          echo "::error::Security scan failed. Review the job outputs for details."
          exit 1
